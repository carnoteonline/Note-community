<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CarNote Online | ‡∏ï‡∏•‡∏≤‡∏î‡∏£‡∏ñ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pM2bQf2H5Q2t3g9w5h8z0Yv1Wq3rZ68e7b0J8zDq8Qx7Xj8v1q6Zl0V6f5y3Xk6s9y1Q6v2K2Q9f3G4v2y1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Firebase (kept as in original) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

  <!-- ====== Enhanced styles (modern, responsive, animations) ====== -->
  <style>
    /* ---------- Design tokens ---------- */
    :root{
      --bg-1: #071021;
      --bg-2: #0b1220;
      --surface: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.06);
      --glass-2: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.06);
      --accent-start: #ff7a18;
      --accent-end: #fb2e86;
      --accent: linear-gradient(135deg,var(--accent-start),var(--accent-end));
      --accent-solid: #fb8c00; /* kept for compatibility */
      --muted: rgba(255,255,255,0.7);
      --text-dark: #0f172a;
      --text-light: #eaf4ff;
      --success: #10b981;
      --danger: #ef4444;
      --radius-lg: 18px;
      --radius-md: 12px;
      --card-shadow: 0 12px 32px rgba(2,6,23,0.6);
      --glass-blur: 10px;
      --max-width: 1100px;
    }

    /* Dark mode variables (applied with data-theme="dark" on <html> or <body>) */
    :root[data-theme="dark"] {
      --bg-1: #071021;
      --bg-2: #041021;
      --surface: rgba(255,255,255,0.02);
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --glass-border: rgba(255,255,255,0.05);
      --muted: rgba(255,255,255,0.72);
      --text-dark: #eaf4ff;
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; transition-duration: 0.001ms !important; }
    }

    /* ---------- Page baseline ---------- */
    html,body{
      height:100%;
      margin:0;
      font-family: "Inter", "Anuphan", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--text-dark);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(251,140,0,0.08), transparent 6%),
        radial-gradient(900px 500px at 90% 80%, rgba(251,46,134,0.06), transparent 8%),
        linear-gradient(180deg,var(--bg-1), var(--bg-2));
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
      transition: background .4s ease, color .3s ease;
    }

    /* Page background layer for subtle floating band & particles */
    .page-bg{
      position:fixed; inset:0; z-index:-2; pointer-events:none;
      overflow:hidden;
    }
    .bg-band{
      position:absolute; left:-20%; right:-20%; top:-30%; height:140%;
      background: linear-gradient(90deg, rgba(255,122,24,0.10), rgba(251,46,134,0.08));
      filter: blur(48px);
      transform: rotate(8deg);
      animation: slow-pan 18s linear infinite;
    }
    @keyframes slow-pan { 0%{transform:rotate(8deg) translateX(-2%)} 50%{transform:rotate(6deg) translateX(2%)} 100%{transform:rotate(8deg) translateX(-2%)} }

    /* subtle glass container */
    .shell{
      max-width: var(--max-width);
      margin: 28px auto;
      padding: 20px;
      box-sizing:border-box;
    }

    /* ---------- Header ---------- */
    nav{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 14px 20px;
      border-radius: 14px;
      margin: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      backdrop-filter: blur(var(--glass-blur));
      position: sticky; top: 12px; z-index: 999;
      transition: transform .28s ease, box-shadow .28s ease;
    }
    nav:hover{ transform: translateY(-2px); }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand .logo-mark{
      width:52px; height:52px; border-radius:12px;
      background: linear-gradient(135deg,#ff7a18,#fb2e86);
      display:inline-grid; place-items:center; color:white; font-weight:700;
      box-shadow: 0 8px 30px rgba(251,46,134,0.12), inset 0 -6px 12px rgba(0,0,0,0.18);
    }
    .brand h1{
      margin:0; font-size:1.05rem; letter-spacing:-0.02em; color:var(--text-dark);
    }
    .nav-actions{ display:flex; gap:10px; align-items:center; }

    .admin-btn{
      padding:10px 14px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.04);
      color:var(--muted); font-weight:600; cursor:pointer; display:inline-flex; gap:8px; align-items:center;
      transition: transform .18s ease, background .18s ease;
    }
    .admin-btn:hover{ transform: translateY(-4px); background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent); }

    .theme-toggle{
      width:44px; height:44px; border-radius:10px; display:grid; place-items:center;
      cursor:pointer; border:1px solid rgba(255,255,255,0.04); background:transparent;
    }

    /* ---------- Hero ---------- */
    .hero-banner{
      margin: 18px 10px;
      border-radius: 18px;
      overflow:hidden;
      display:flex; gap:18px; align-items:center; padding:18px;
      background: linear-gradient(135deg, rgba(255,122,24,0.18), rgba(251,46,134,0.12));
      border: 1px solid rgba(255,255,255,0.03); box-shadow: 0 12px 36px rgba(2,6,23,0.5);
      backdrop-filter: blur(6px);
    }
    .hero-content{ flex:1; color:var(--text-dark); }
    .hero-title{ margin:0; font-size: clamp(1.25rem, 2.4vw, 1.8rem); font-weight:800; letter-spacing:-0.02em; }
    .hero-sub{ margin:6px 0 0 0; font-size:0.95rem; color:var(--muted); }

    .hero-visual{
      width:120px; height:120px; border-radius:14px; overflow:hidden; flex-shrink:0;
      border: 1px solid rgba(255,255,255,0.04);
      display:grid; place-items:center; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    }
    .hero-visual img{ width:90px; height:90px; object-fit:cover; border-radius:12px; }

    /* ---------- Container & Admin Panel ---------- */
    .container{
      margin: 18px 10px;
      display:grid; gap:18px;
      grid-template-columns: 1fr 420px;
      align-items:start;
    }
    @media (max-width:1100px){ .container{ grid-template-columns: 1fr; } }

    #adminPanel{
      position:sticky; top:84px;
      border-radius:16px;
      padding:18px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: 0 12px 30px rgba(2,6,23,0.55);
      backdrop-filter: blur(var(--glass-blur));
      display:none; /* toggled by admin login */
    }
    #adminPanel.show{ display:block; animation: slideFadeIn .48s cubic-bezier(.2,.9,.25,1); }
    @keyframes slideFadeIn { from{ opacity:0; transform:translateY(12px) } to{ opacity:1; transform:translateY(0) } }

    input[type="text"], input[type="password"], input[type="file"], select, textarea{
      width:100%; padding:12px 14px; border-radius:12px; font-size:0.95rem;
      border:1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:var(--text-dark); box-sizing:border-box; outline:none;
      transition: box-shadow .14s ease, transform .12s ease;
    }
    input:focus, select:focus, textarea:focus{ box-shadow: 0 10px 28px rgba(124,58,237,0.08); transform: translateY(-2px); }

    .file-label{
      display:block; padding:12px; border-radius:12px; text-align:center; cursor:pointer;
      border:2px dashed rgba(255,255,255,0.04); color:var(--muted); background:transparent;
    }

    .btn-post{
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      width:100%; padding:12px 14px; border-radius:12px; color:white; font-weight:700; border:none;
      background: linear-gradient(90deg,var(--accent-start),var(--accent-end));
      box-shadow: 0 12px 34px rgba(251,46,134,0.12);
      cursor:pointer; transition: transform .18s cubic-bezier(.2,.9,.25,1), filter .18s;
    }
    .btn-post:active{ transform: translateY(1px) scale(.998); }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

    /* ---------- Car list / cards ---------- */
    #carList{ display:grid; gap:18px; }
    .car-card{
      border-radius:16px; overflow:hidden; position:relative;
      border: 1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: 0 12px 36px rgba(2,6,23,0.5);
      display:flex; flex-direction:column;
      transition: transform .28s cubic-bezier(.2,.9,.25,1), box-shadow .28s;
      will-change: transform;
    }
    .car-card:hover{ transform: translateY(-6px); box-shadow: 0 26px 60px rgba(2,6,23,0.6); }

    .car-top{
      position:relative; min-height:260px; background:#111;
    }
    .car-img{ width:100%; height:100%; object-fit:cover; display:block; min-height:260px; }

    .status-tag{
      position:absolute; top:16px; left:16px; padding:8px 12px; border-radius:999px; color:white; font-weight:800;
      font-size:0.78rem; text-transform:uppercase; letter-spacing:0.04em; box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
    }
    .tag-available{ background: linear-gradient(90deg,#10b981,#06b6d4); }
    .tag-sold{ background: linear-gradient(90deg,#ef4444,#fb7185); }

    .details{ padding: 18px; display:flex; flex-direction:column; gap:8px; }
    .details h2{ margin:0; font-size:1.05rem; }
    .price{ margin-top:2px; font-size:1.4rem; font-weight:800; color:var(--accent-start); }

    .contact-area{ display:flex; gap:10px; margin-top:8px; }
    .btn-contact{
      flex:1; padding:10px 12px; border-radius:12px; display:inline-flex; gap:8px; align-items:center; justify-content:center;
      color:white; text-decoration:none; font-weight:700; box-shadow: 0 8px 26px rgba(0,0,0,0.22);
      transition: transform .16s ease, box-shadow .16s ease;
    }
    .btn-contact:hover{ transform: translateY(-3px); box-shadow: 0 18px 40px rgba(0,0,0,0.32); }
    .btn-facebook{ background: linear-gradient(90deg,#1877F2,#166FE5); }
    .btn-phone{ background: linear-gradient(90deg,#0f172a,#394b6b); }

    .admin-controls{ display:flex; gap:10px; margin-top:12px; }
    .btn-edit{ flex:1; padding:10px; background: linear-gradient(90deg,#fef3c7,#fde68a); border-radius:10px; color:#92400e; font-weight:800; border:none; cursor:pointer; }
    .btn-del{ flex:1; padding:10px; background: linear-gradient(90deg,#fee2e2,#fecaca); border-radius:10px; color:#991b1b; font-weight:800; border:none; cursor:pointer; }

    .comment-section{ padding:14px 18px; border-top:1px solid rgba(255,255,255,0.02); background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    .comment-item{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); margin-bottom:8px; position:relative; font-size:0.9rem; }

    .btn-del-cmt{ position:absolute; right:8px; top:8px; background:transparent; border:none; color:var(--danger); cursor:pointer; }

    /* ---------- Overlays & modals ---------- */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));
      backdrop-filter: blur(8px); z-index:3000; padding:18px;
    }
    .welcome-card{
      width:100%; max-width:360px; border-radius:16px; padding:20px; text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: 0 28px 80px rgba(2,6,23,0.7);
      animation: popIn .36s cubic-bezier(.2,.9,.25,1);
    }
    @keyframes popIn{ from{ opacity:0; transform:translateY(10px) scale(.98) } to{ opacity:1; transform:none } }
    .loader{
      width:56px; height:56px; border-radius:50%;
      border:6px solid rgba(255,255,255,0.06); border-left-color: transparent; border-right-color: transparent;
      border-bottom-color: var(--accent-start); margin: 10px auto 8px auto; animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    /* ---------- Utility / animations ---------- */
    .reveal { opacity:0; transform: translateY(10px) scale(.995); transition: opacity .6s cubic-bezier(.2,.9,.25,1), transform .6s cubic-bezier(.2,.9,.25,1); }
    .reveal.visible{ opacity:1; transform:none; }

    .small{ font-size:0.86rem; color:var(--muted); }

    /* ---------- Responsive tweaks ---------- */
    @media (max-width:720px){
      .hero-visual{ display:none; }
      nav{ padding:12px; margin:8px; }
      .shell{ padding:12px; }
      .hero-banner{ flex-direction:column; align-items:flex-start; gap:10px; padding:14px; }
      #adminPanel{ position:static; top:auto; }
    }

  </style>
</head>
<body>

  <div class="page-bg" aria-hidden="true">
    <div class="bg-band"></div>
    <canvas id="particles" class="particles" style="position:absolute; inset:0; width:100%; height:100%;"></canvas>
  </div>

  <div class="shell">
    <!-- Header -->
    <nav>
      <div class="brand">
        <div class="logo-mark" aria-hidden="true">CN</div>
        <div>
          <h1>CarNote Online</h1>
          <div class="small">‡∏ï‡∏•‡∏≤‡∏î‡∏£‡∏ñ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</div>
        </div>
      </div>

      <div class="nav-actions">
        <button id="themeToggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">
          <i id="themeIcon" class="fa-regular fa-moon"></i>
        </button>
        <button id="adminBtn" class="admin-btn" onclick="handleAdmin()" title="Admin access">‚öôÔ∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
      </div>
    </nav>

    <!-- Hero -->
    <section class="hero-banner reveal" aria-labelledby="heroTitle">
      <div class="hero-content">
        <h2 id="heroTitle" class="hero-title">CarNote Online</h2>
        <p class="hero-sub">Premium Quality Second Hand Cars üß° ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</p>
      </div>
      <div class="hero-visual" aria-hidden="true">
        <img src="Icon.png" alt="CarNote Logo">
      </div>
    </section>

    <!-- Main content grid -->
    <main class="container">
      <!-- Left: car list -->
      <div id="carList" class="reveal" aria-live="polite"></div>

      <!-- Right: admin panel (hidden until admin login) -->
      <aside id="adminPanel" class="reveal" aria-hidden="true">
        <h4 id="panelTitle" style="margin:0 0 12px 0;">‚ú® ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h4>
        <input type="text" id="carTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô / ‡∏õ‡∏µ" />
        <input type="text" id="carPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" />
        <label for="carFile" id="fileLabel" class="file-label">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏£‡∏ñ</label>
        <input type="file" id="carFile" accept="image/*" style="display:none" onchange="document.getElementById('fileLabel').innerText = 'üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ' + this.files[0].name" />
        <select id="carStatus">
          <option value="available">üü¢ ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢)</option>
          <option value="sold">üî¥ ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢)</option>
        </select>
        <button id="uploadBtn" class="btn-post" onclick="startUpload()">‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
        <button id="cancelEditBtn" class="btn-ghost" onclick="location.reload()" style="display:none; margin-top:8px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </aside>
    </main>
  </div>

  <!-- Loading & overlays (kept IDs and behavior) -->
  <div id="loadingOverlay" class="overlay" style="display:none; opacity:0; transition:opacity .18s;">
    <div class="welcome-card" style="max-width:220px;">
      <div class="loader" role="status" aria-hidden="true"></div>
      <h4 style="margin:0; color:var(--accent-start);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h4>
    </div>
  </div>

  <div id="welcomePopup" class="overlay" aria-modal="true">
    <div class="welcome-card">
      <img src="Icon.png" style="width:110px; height:110px; border-radius:16px; margin-bottom:12px; object-fit:cover;" alt="Icon">
      <h3 style="margin:0; font-weight:800;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà <span style="background:var(--accent); -webkit-background-clip:text; background-clip:text; color:transparent;">CarNote Online</span></h3>
      <p style="color:var(--muted); margin:10px 0 18px;">Premium Quality Second Hand Cars üß°</p>
      <button id="welcomeStart" class="btn-post" onclick="closeWelcome()" aria-label="Start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
    </div>
  </div>

  <div id="adminModal" class="overlay" style="display:none; opacity:0;">
    <div class="welcome-card" style="border-top:6px solid var(--accent-start);">
      <h3 style="margin:0; font-weight:800;">üîê ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¥‡∏ô</h3>
      <input type="password" id="adminPassInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" style="text-align:center; letter-spacing:5px; margin-top:18px;" />
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button onclick="closeAdminModal()" class="btn-ghost" style="flex:1;">‡∏õ‡∏¥‡∏î</button>
        <button onclick="checkAdminPass()" class="btn-post" style="flex:2;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </div>

  <!-- ===== Original app script (kept intact to preserve functionality) ===== -->
  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyANA3-UyKf-MS2dcmbAuPGt-KtRd0KTmGw",
        authDomain: "note-communitycar.firebaseapp.com",
        databaseURL: "https://note-communitycar-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "note-communitycar",
        storageBucket: "note-communitycar.appspot.com",
        messagingSenderId: "387457886547",
        appId: "1:387457886547:web:d7e5f60fb7d2cdbf3ed9a6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const IMGBB_API_KEY = '5a3de96d3f6deddc05d65dc1928e466b';
    let isAdmin = false, editMode = false, editKey = null, existingImgUrl = null;

    function closeWelcome() { 
        const w = document.getElementById('welcomePopup');
        w.style.transition = 'opacity .25s ease, transform .25s ease';
        w.style.opacity = '0';
        w.style.transform = 'scale(.98)';
        setTimeout(()=> w.style.display = 'none', 280);
    }
    function handleAdmin() {
        if (!isAdmin) { 
            const modal = document.getElementById('adminModal'); modal.style.display = 'flex'; setTimeout(()=> { modal.style.opacity = '1'; }, 20);
        }
        else { isAdmin = false; location.reload(); }
    }
    function closeAdminModal() { 
        const modal = document.getElementById('adminModal'); modal.style.opacity = '0'; setTimeout(()=> modal.style.display = 'none', 240);
    }
    function checkAdminPass() {
        if (document.getElementById('adminPassInput').value === "Note#2026!Car@Phupha99") {
            isAdmin = true;
            document.getElementById('adminPanel').classList.add('show');
            document.getElementById('adminBtn').innerText = "üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô";
            closeAdminModal();
            renderCars();
        } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); }
    }

    async function startUpload() {
        const title = document.getElementById('carTitle').value, price = document.getElementById('carPrice').value;
        const file = document.getElementById('carFile').files[0], status = document.getElementById('carStatus').value;
        if(!title || !price) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        const loading = document.getElementById('loadingOverlay');
        loading.style.display = 'flex'; loading.style.opacity = '1';

        try {
            let finalImageUrl = existingImgUrl;
            if (file) {
                const formData = new FormData(); formData.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const data = await res.json(); finalImageUrl = data.data.url;
            }
            if (editMode) { await db.ref(`cars/${editKey}`).update({ title, price, img: finalImageUrl, status }); }
            else { await db.ref('cars').push({ title, price, img: finalImageUrl, status, time: Date.now() }); }
            
            loading.style.opacity = '0';
            setTimeout(()=> { loading.style.display = 'none'; location.reload(); }, 220);
        } catch (err) { 
            alert("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            const loading = document.getElementById('loadingOverlay');
            loading.style.opacity = '0';
            setTimeout(()=> loading.style.display = 'none', 220);
        }
    }

    function renderCars() {
        db.ref('cars').on('value', snapshot => {
            const list = document.getElementById('carList'); list.innerHTML = "";
            const data = snapshot.val();
            if(data) {
                Object.keys(data).reverse().forEach(key => {
                    const car = data[key] || {};
                    list.innerHTML += `
                        <div class="car-card">
                            <div class="car-top">
                                <div class="status-tag ${car.status === 'available' ? 'tag-available' : 'tag-sold'}">${car.status === 'available' ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢' : '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß'}</div>
                                <img src="${car.img || 'Icon.png'}" class="car-img" alt="${(car.title || '‡∏£‡∏ñ')}" />
                            </div>
                            <div class="details">
                                <h2 style="margin:0; font-size:1.1rem; font-weight:700;">${car.title || ''}</h2>
                                <div class="price">‡∏ø${car.price || ''}</div>
                                <div class="contact-area">
                                    <a target="_blank" rel="noopener" href="https://m.me/note.notety.5" class="btn-contact btn-facebook">üí¨ ‡πÅ‡∏ä‡∏ó‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</a>
                                    <a href="tel:0835255642" class="btn-contact btn-phone">üìû ‡πÇ‡∏ó‡∏£</a>
                                </div>
                                ${isAdmin ? `<div class="admin-controls">
                                    <button class="btn-edit" onclick="editPost('${key}', '${(car.title||'').replace(/'/g, "\\'")}', '${car.price || ''}', '${car.status || 'available'}', '${car.img || ''}')">üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button class="btn-del" onclick="deletePost('${key}')">üóëÔ∏è ‡∏•‡∏ö</button>
                                </div>` : ''}
                            </div>
                            <div class="comment-section">
                                <div id="comments-${key}"></div>
                                <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
                                    <input type="text" id="name-${key}" placeholder="‡∏ä‡∏∑‡πà‡∏≠" style="flex:1; margin-bottom:0; font-size:0.9rem; padding:9px;">
                                    <input type="text" id="text-${key}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="flex:2; margin-bottom:0; font-size:0.9rem; padding:9px;">
                                    <button onclick="addComment('${key}')" style="background:linear-gradient(90deg,var(--accent-start),var(--accent-end)); color:white; border:none; border-radius:10px; padding:10px 14px; cursor:pointer;">‡∏™‡πà‡∏á</button>
                                </div>
                            </div>
                        </div>`;
                    renderComments(key);
                });
                // show reveal animation for newly inserted cards
                requestAnimationFrame(()=> { document.querySelectorAll('#carList > .car-card').forEach((c,i)=> { c.classList.add('reveal'); setTimeout(()=> c.classList.add('visible'), 80*i); }); });
            }
        });
    }

    function editPost(key, title, price, status, img) {
        editMode = true; editKey = key; existingImgUrl = img;
        document.getElementById('panelTitle').innerText = "üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®";
        document.getElementById('carTitle').value = title;
        document.getElementById('carPrice').value = price;
        document.getElementById('carStatus').value = status;
        document.getElementById('uploadBtn').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
        document.getElementById('cancelEditBtn').style.display = 'block';
        document.getElementById('adminPanel').classList.add('show');
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function addComment(carId) {
        const text = document.getElementById(`text-${carId}`).value;
        if(!text) return;
        db.ref(`cars/${carId}/comments`).push({ name: document.getElementById(`name-${carId}`).value || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", text });
        document.getElementById(`text-${carId}`).value = "";
    }

    function renderComments(carId) {
        db.ref(`cars/${carId}/comments`).on('value', snap => {
            const div = document.getElementById(`comments-${carId}`); if(!div) return; div.innerHTML = "";
            const cData = snap.val();
            if(cData) {
                Object.keys(cData).forEach(cKey => {
                    div.innerHTML += `<div class="comment-item">
                        <b>${cData[cKey].name}:</b> ${cData[cKey].text}
                        ${isAdmin ? `<button class="btn-del-cmt" onclick="db.ref('cars/${carId}/comments/${cKey}').remove()">‚ùå</button>` : ''}
                    </div>`;
                });
            }
        });
    }

    function deletePost(id) { if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) db.ref(`cars/${id}`).remove(); }
    renderCars();
  </script>

  <!-- ===== UI enhancements script (animations, particles, dark mode, microinteractions) ===== -->
  <script>
    (function(){
      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const root = document.documentElement;

      // Initialize theme from localStorage or prefer-color-scheme
      const saved = localStorage.getItem('cn-theme');
      if(saved) root.setAttribute('data-theme', saved);
      else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) root.setAttribute('data-theme','dark');

      const applyIcon = () => {
        const isDark = root.getAttribute('data-theme') === 'dark';
        themeIcon.className = isDark ? 'fa-solid fa-sun' : 'fa-regular fa-moon';
      };
      applyIcon();

      themeToggle.addEventListener('click', ()=>{
        const cur = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = cur === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next === 'dark' ? 'dark' : 'light');
        localStorage.setItem('cn-theme', next === 'dark' ? 'dark' : 'light');
        applyIcon();
      });

      // Intersection reveal for elements with class 'reveal'
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting) { e.target.classList.add('visible'); io.unobserve(e.target); }
        });
      }, { threshold: 0.12 });
      document.querySelectorAll('.reveal').forEach(el=> io.observe(el));

      // Button ripple micro-interaction for primary buttons
      document.addEventListener('pointerdown', e=>{
        const btn = e.target.closest('.btn-post, .admin-btn, .theme-toggle, .btn-ghost, .btn-edit, .btn-del');
        if(!btn) return;
        const rect = btn.getBoundingClientRect();
        const circle = document.createElement('span');
        const size = Math.max(rect.width, rect.height) * 1.8;
        circle.style.width = circle.style.height = size + 'px';
        circle.style.position = 'absolute';
        circle.style.left = (e.clientX - rect.left - size/2) + 'px';
        circle.style.top = (e.clientY - rect.top - size/2) + 'px';
        circle.style.background = 'rgba(255,255,255,0.08)';
        circle.style.borderRadius = '50%';
        circle.style.pointerEvents = 'none';
        circle.style.transform = 'scale(0.2)';
        circle.style.transition = 'transform .5s cubic-bezier(.2,.9,.25,1), opacity .5s';
        circle.style.opacity = '0.95';
        circle.style.zIndex = '9';
        btn.style.position = btn.style.position || 'relative';
        btn.appendChild(circle);
        requestAnimationFrame(()=> circle.style.transform = 'scale(1)');
        setTimeout(()=> {
          circle.style.opacity = '0';
          setTimeout(()=> circle.remove(), 500);
        }, 350);
      });

      // Particles (lightweight) ‚Äî canvas-based, optimized
      const canvas = document.getElementById('particles');
      let ctx, W, H, particles=[];
      const particleCount = Math.min(80, Math.floor(window.innerWidth / 14));
      function resizeCanvas(){
        canvas.width = W = canvas.clientWidth || window.innerWidth;
        canvas.height = H = canvas.clientHeight || window.innerHeight;
      }
      function initParticles(){
        particles = [];
        for(let i=0;i<particleCount;i++){
          particles.push({
            x: Math.random()*W,
            y: Math.random()*H,
            vx: (Math.random()-0.5)*0.25,
            vy: (Math.random()-0.5)*0.25,
            r: (Math.random()*2)+0.6,
            alpha: 0.06 + Math.random()*0.12,
            hue: 10 + Math.random()*340
          });
        }
      }
      function drawParticles(){
        ctx.clearRect(0,0,W,H);
        for(const p of particles){
          p.x += p.vx;
          p.y += p.vy;
          if(p.x < -10) p.x = W + 10;
          if(p.x > W + 10) p.x = -10;
          if(p.y < -10) p.y = H + 10;
          if(p.y > H + 10) p.y = -10;
          ctx.beginPath();
          const grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r*6);
          grd.addColorStop(0, `hsla(${p.hue}, 85%, 65%, ${p.alpha})`);
          grd.addColorStop(1, `hsla(${p.hue}, 85%, 65%, 0)`);
          ctx.fillStyle = grd;
          ctx.arc(p.x, p.y, p.r*6, 0, Math.PI*2, false);
          ctx.fill();
        }
      }
      function loop(){
        drawParticles();
        requestAnimationFrame(loop);
      }
      function startParticles(){
        if(!canvas) return;
        ctx = canvas.getContext('2d');
        resizeCanvas(); initParticles();
        loop();
      }
      window.addEventListener('resize', ()=> { if(canvas) { resizeCanvas(); initParticles(); } });

      // Start particles after small throttle to let layout settle
      setTimeout(startParticles, 240);

      // Attach small animation for welcome overlay and loading overlay
      const loadingOverlay = document.getElementById('loadingOverlay');
      const realWelcome = document.getElementById('welcomePopup');

      // Ensure overlays use fade transitions consistently
      function showLoading(){ loadingOverlay.style.display = 'flex'; requestAnimationFrame(()=> loadingOverlay.style.opacity = '1'); }
      function hideLoading(){ loadingOverlay.style.opacity = '0'; setTimeout(()=> loadingOverlay.style.display='none', 240); }

      // Replace direct inline style toggles: observe DOM mutation to animate display changes from original script
      const obs = new MutationObserver((mutations)=>{
        for(const m of mutations){
          if(m.target.id === 'loadingOverlay'){
            // noop: original script sets display/opacity already; just ensure transition
            // keep in sync
            if(getComputedStyle(loadingOverlay).display === 'flex' && loadingOverlay.style.opacity !== '1') requestAnimationFrame(()=> loadingOverlay.style.opacity = '1');
          }
        }
      });
      obs.observe(document.body, { attributes: true, subtree: true });

      // Accessibility: close welcome popup with escape key
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          const w = document.getElementById('welcomePopup');
          if(w && w.style.display !== 'none') closeWelcome();
          const am = document.getElementById('adminModal');
          if(am && am.style.display !== 'none') closeAdminModal();
        }
      });

      // small polish: ensure admin panel reveals when isAdmin toggled from original script
      const adminObserver = new MutationObserver(()=> {
        const panel = document.getElementById('adminPanel');
        if(panel && panel.classList.contains('show')) {
          panel.setAttribute('aria-hidden','false');
          panel.classList.add('visible');
        }
      });
      adminObserver.observe(document.getElementById('adminPanel'), { attributes: true, attributeFilter: ['class'] });

      // Make file label clickable
      document.getElementById('fileLabel').addEventListener('click', ()=> document.getElementById('carFile').click());

      // Ensure hero reveal animates on load
      document.addEventListener('DOMContentLoaded', ()=> {
        document.querySelectorAll('.reveal').forEach((el, i)=> {
          setTimeout(()=> el.classList.add('visible'), 80 + i*60);
        });
      });

    })();
  </script>
</body>
</html>
